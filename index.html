<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Harith Design System v1.0.0 -->
    <link rel="stylesheet" href="https://harithkavish.github.io/harith-design-system/v1.0.0/tokens.css">
    <link rel="stylesheet" href="https://harithkavish.github.io/harith-design-system/v1.0.0/base.css">
    <link rel="stylesheet" href="https://harithkavish.github.io/harith-design-system/v1.0.0/components.css">
    <link rel="stylesheet" href="https://harithkavish.github.io/harith-design-system/v1.0.0/utils.css">

    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" href="https://harithkavish.github.io/favicon.svg" type="image/svg+xml" />
    <!-- Transformers.js -->
    <script src="https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.1"></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Harith Design System logic -->
    <script src="https://harithkavish.github.io/harith-design-system/v1.0.0/theme-toggle.js"></script>
    <script src="https://harithkavish.github.io/harith-design-system/v1.0.0/harith-shell.js"></script>

    <meta name="google-site-verification" content="SdeY2poCFNBw9AeQhlC5LVYL7NzT0lSyjJR8xMHkto8" />
</head>

<body>
    <div id="sharedHeader"></div>
    <main class="page">
        <div class="ai-chat-wrapper">
            <!-- Sidebar -->
            <aside class="chat-sidebar">
                <button class="new-chat-btn" id="new-chat-btn">+ New Chat</button>
                <div class="chat-list" id="chat-list"></div>
            </aside>

            <!-- Main Chat Area -->
            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <h1>AI Assistant</h1>
                        <p class="subtitle">Powered by DistilGPT2</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 12px;">
                        <span id="auth-status" style="flex: 1;">Not signed in</span>
                        <span id="sync-status" style="display: none; color: var(--accent);">Syncing...</span>
                    </div>
                    <div class="status" id="model-status">Loading model...</div>
                </div>
                <div id="messages" class="messages">
                    <div class="welcome">
                        <h2>Welcome to AI Chat</h2>
                        <p>Ask me anything! I'll respond with thoughtful answers.</p>
                    </div>
                </div>
                <form id="message-form" class="message-form">
                    <input id="message-input" name="message" type="text" placeholder="Ask me something..."
                        autocomplete="off" />
                    <button type="submit" id="send-button">Send</button>
                </form>
            </div>
        </div>
    </main>
    <div id="sharedFooter"></div>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Render Shell
            if (typeof HarithShell !== 'undefined') {
                HarithShell.renderHeader({
                    target: '#sharedHeader',
                    brand: { title: 'AI Chat', tagline: 'Assistant powered by DistilGPT2' },
                    navLinks: [
                        { label: 'Home', href: 'https://harithkavish.github.io/' }
                    ]
                });
                HarithShell.renderFooter({ target: '#sharedFooter', text: 'Harith Kavish' });
            }

            // 2. Initialize Theme Toggle
            const toggleBtn = document.getElementById('darkModeToggle');
            if (toggleBtn && window.HarithTheme) {
                toggleBtn.addEventListener('click', HarithTheme.toggle);
                const current = HarithTheme.get();
                toggleBtn.textContent = current === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            // 3. User Profile / Google Sign-In Logic
            const GOOGLE_USER_KEY = 'harith_google_user';
            const googleBtnTarget = document.getElementById('googleSignInButton');

            function renderProfile(user) {
                if (!googleBtnTarget) return;
                const dropdownId = 'userProfileDropdown';
                googleBtnTarget.style.position = 'relative';

                googleBtnTarget.innerHTML = `
                    <button type="button" class="signed-in-button" aria-label="Signed in as ${user.name}" aria-expanded="false" aria-controls="${dropdownId}">
                        <img src="${user.picture || 'https://www.gravatar.com/avatar/?d=mp'}" alt="${user.name}" class="signed-in-button__avatar" loading="lazy" />
                    </button>
                    <div id="${dropdownId}" class="user-dropdown-menu">
                        <div class="user-dropdown-header">
                            <span class="user-dropdown-name">${user.name}</span>
                        </div>
                        <button type="button" class="user-dropdown-action" id="logoutBtn">
                             <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Sign Out
                        </button>
                    </div>`;

                const btn = googleBtnTarget.querySelector('.signed-in-button');
                const dropdown = document.getElementById(dropdownId);
                const logout = document.getElementById('logoutBtn');

                btn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const expanded = btn.getAttribute('aria-expanded') === 'true';
                    btn.setAttribute('aria-expanded', !expanded);
                    btn.classList.toggle('active');
                    dropdown.classList.toggle('show');
                });

                dropdown?.addEventListener('click', e => e.stopPropagation());

                logout?.addEventListener('click', () => {
                    localStorage.removeItem(GOOGLE_USER_KEY);
                    location.reload();
                });

                document.addEventListener('click', () => {
                    if (btn) {
                        btn.setAttribute('aria-expanded', 'false');
                        btn.classList.remove('active');
                    }
                    if (dropdown) dropdown.classList.remove('show');
                });
            }

            function decodeJwt(credential) {
                try {
                    const payload = credential.split('.')[1];
                    const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
                    const decoded = decodeURIComponent(atob(base64)
                        .split('')
                        .map(char => '%' + ('00' + char.charCodeAt(0).toString(16)).slice(-2))
                        .join(''));
                    return JSON.parse(decoded);
                } catch (e) { return null; }
            }

            function initGSI() {
                if (!googleBtnTarget) return;
                // Check stored user first
                try {
                    const stored = localStorage.getItem(GOOGLE_USER_KEY);
                    if (stored) {
                        const user = JSON.parse(stored);
                        if (user && user.name) {
                            renderProfile(user);
                            return;
                        }
                    }
                } catch (e) { }

                // Initialize Google Button
                if (window.google) {
                    google.accounts.id.initialize({
                        client_id: "235284376269-a8bgbs53t4jp8j82s38dbu621l47484o.apps.googleusercontent.com",
                        callback: (response) => {
                            const payload = decodeJwt(response.credential);
                            if (payload) {
                                const user = {
                                    name: payload.name,
                                    picture: payload.picture,
                                    email: payload.email
                                };
                                localStorage.setItem(GOOGLE_USER_KEY, JSON.stringify(user));
                                renderProfile(user);
                            }
                        }
                    });
                    google.accounts.id.renderButton(googleBtnTarget, { theme: "outline", size: "large", shape: "pill" });
                }
            }

            setTimeout(initGSI, 100);
        });
    </script>
    <script defer src="app.js"></script>
</body>

</html>